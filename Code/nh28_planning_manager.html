<!DOCTYPE html>
<!-- *******************************************************************************************************************************************************
                                                         ***** DO NOT REMOVE THIS COPYRIGHT NOTICE *****
****    THIS CODE IS COPYRIGHT Philippe PRADEL AND IS PROTECTED UNDER SACD PATENTS n¬∞ 000588372, 000707489, 000711914, 000784144, 000817384 (2022-2072) ****
                                                                         https://e-dpo.com/
                                                    *** NH28 GALAXY IS AN INPI TRADEMARK PROTECTED UNDER  n¬∞ 5154267 ***
                                                    for more information about licensing for commercial use please visit
                                                             https://nh28.net/NH28_LICENCE_AGREEMENT.pdf
     *******************************************************************************************************************************************************
-->
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NH28_Planning</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .smart-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 15px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls-right {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
            min-width: 150px;
        }

            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4);
            }

        .btn-blue {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }

        .btn-green {
            background: linear-gradient(135deg, #00b894, #00a085);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }

        .btn-orange {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: black;
            box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
        }

        .btn-purple {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .btn-yellow {
            background: yellow;
            color: black;
            box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
        }

        .btn-red {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            box-shadow: 0 4px 15px rgba(225, 112, 85, 0.3);
        }

        .object-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

            .object-selector input[type="text"] {
                flex: 1;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 10px;
                font-size: 1em;
                min-width: 200px;
            }

        select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            min-width: 150px;
        }

        .text-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

            .text-filter textarea {
                flex: 1;
                min-width: 300px;
                padding: 8px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                min-height: 40px;
                resize: both;
            }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .keywords-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #007bff;
        }

        .keyword-stat-card {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #fd79a8;
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #007bff;
        }

        .keyword-stat-number {
            font-size: 1.4em;
            font-weight: bold;
            color: #fd79a8;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .keyword-stat-label {
            color: #6c757d;
            font-size: 0.8em;
            margin-top: 3px;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e3f2fd;
        }

        .task-cell, .url-cell, .color-cell {
            position: relative;
            min-height: 40px;
        }

            .task-cell textarea, .url-cell textarea {
                width: 100%;
                min-height: 35px;
                border: 1px solid #ccc;
                border-radius: 5px;
                padding: 5px;
                font-family: inherit;
                font-size: 0.9em;
                resize: both;
                background: white;
                transition: all 0.3s ease;
            }

            .url-cell textarea {
                min-width: 200px;
            }

                .task-cell textarea:focus, .url-cell textarea:focus {
                    border-color: #007bff;
                    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
                }

            .task-cell textarea.empty {
                background: #f8f9fa;
                color: #6c757d;
            }

            .task-cell.dragging, .url-cell.dragging, .color-cell.dragging {
                opacity: 0.5;
                background: #fff3cd;
            }

            .task-cell.drop-zone, .url-cell.drop-zone, .color-cell.drop-zone {
                background: #d4edda;
                border: 2px dashed #28a745;
            }

        .color-selector-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-selector {
            flex: 1;
            min-width: 120px;
        }

        .color-preview {
            width: 30px;
            height: 30px;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .url-link {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            text-decoration: none;
            font-size: 0.8em;
            margin-top: 5px;
        }

            .url-link:hover {
                background: #0056b3;
            }

        .calendar-view {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        }

        .calendar-week {
            margin-bottom: 30px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .calendar-week-header {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            padding: 15px;
            font-weight: bold;
            font-size: 1.2em;
            text-align: center;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
        }

        .calendar-day {
            background: white;
            padding: 15px;
            min-height: 120px;
        }

        .calendar-day-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .calendar-task {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 5px;
            font-size: 0.8em;
            word-wrap: break-word;
            display: block;
            width: 100%;
        }

            .calendar-task.empty {
                background: #e9ecef;
                color: #6c757d;
            }

            .calendar-task.preparer {
                background: #6c5ce7;
                color: white;
                font-weight: bold;
            }

            .calendar-task.dispenser {
                background: #fdcb6e;
                color: black;
            }

            .calendar-task.code {
                background: #2d3436;
                color: white;
                font-weight: bold;
            }

            .calendar-task.suivre {
                background: #fd79a8;
                color: black;
            }

            .calendar-task.visio {
                background: #d63031;
                color: white;
                font-weight: bold;
            }

            .calendar-task.transport {
                background: #00b894;
                color: white;
            }

        .calendar-url-link {
            display: inline-block;
            background: white;
            color: black;
            padding: 1px 4px;
            margin-left: 6px;
            border-radius: 3px;
            text-decoration: none;
            font-size: 0.7em;
            cursor: pointer;
            border: 1px solid #ddd;
            font-weight: bold;
        }

            .calendar-url-link:hover {
                background: #f8f9fa;
            }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 70%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

            .close:hover {
                color: #d63031;
            }

        .planning-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .planning-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .planning-item:hover {
                background: #f8f9fa;
                transform: translateX(5px);
            }

            .planning-item:last-child {
                border-bottom: none;
            }

        .planning-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .planning-size {
            font-size: 0.8em;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .status-message {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
        }

        .status-success {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
        }

        .status-error {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
        }

        .status-warning {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
        }

        .repeated-tasks {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .repeated-task-item {
            background: white;
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
            border-left: 4px solid #fdcb6e;
            font-size: 0.9em;
        }

        .keywords-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .keywords-title {
            color: #2c3e50;
            margin: 0;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            min-width: auto;
        }

        .keyword-manager {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #fd79a8;
        }

        .keyword-list {
            margin: 20px 0;
        }

        .keyword-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #fd79a8;
        }

        .keyword-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

            .keyword-input.keyword-field {
                max-width: 150px;
            }

            .keyword-input.label-field {
                max-width: 200px;
            }

        .btn-remove {
            background: linear-gradient(135deg, #e17055, #d63031);
            padding: 6px 12px;
            font-size: 0.8em;
            min-width: auto;
        }

        .btn-add {
            background: linear-gradient(135deg, #00b894, #00a085);
            margin-top: 10px;
        }

        .keyword-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        /* Styles pour G√©rer Le Temps */
        .time-manager {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #e17055;
        }

        .time-element {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #e17055;
        }

        .time-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .slider-arrow {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            min-width: 40px;
        }

            .slider-arrow:hover {
                background: #0056b3;
                transform: scale(1.1);
            }

        .slider-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            overflow: hidden;
        }

        .week-slider-item, .day-button {
            background: white;
            border: 2px solid #dee2e6;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: black;
        }

            .week-slider-item:hover, .day-button:hover {
                background: #e3f2fd;
                border-color: #007bff;
            }

            .week-slider-item.selected, .day-button.selected {
                background: red;
                color: white;
                border-color: #d63031;
            }

        .days-row {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .day-button {
            flex: 1;
            min-width: 80px;
            text-align: center;
        }

        .circular-slider {
            display: flex;
            gap: 10px;
            overflow: hidden;
            align-items: center;
        }

        .circular-item {
            background: white;
            border: 2px solid #28a745;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #28a745;
        }

            .circular-item:hover {
                background: #e8f5e8;
            }

            .circular-item.selected {
                background: #d63031;
                color: white;
                border-color: #d63031;
            }

        .table-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .time-manager-btn {
            max-width: 300px;
        }

        .section-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .controls-layout {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .left-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .right-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #copilotPopup {
            position: absolute;
            background-color: white;
            border: 1px solid black;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #popupContent {
            text-align: center;
        }

            #popupContent img {
                display: block;
                margin: 0 auto;
            }

        #closePopup {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }

            h1 {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-content {
                width: 90%;
                margin: 5% auto;
                padding: 20px;
            }

            .calendar-days {
                grid-template-columns: 1fr;
            }

            .controls-layout {
                flex-direction: column;
                align-items: stretch;
            }

            .left-controls, .right-controls {
                justify-content: center;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Planning / Project Manager<span class="smart-badge">üß† NH28 GALAXY<sup>TM</sup></span></h1>

        <!-- Contr√¥les principaux -->
        <div class="controls-layout">
            <div class="left-controls">
                <button id="loadPlanningBtn" class="btn-blue">üìÇ Charger Planning</button>
                <button id="timeManagerBtn" class="btn-red time-manager-btn">‚è∞ G√©rer Le Temps</button>
                <button id="statsBtn" class="btn-yellow">üìä Statistiques</button>
            </div>
            <div class="right-controls">
                <button id="autoSaveBtn" class="btn-purple">üíæ Auto-Save: OFF</button>
            </div>
        </div>

        <!-- Nom d'objet et sauvegarde -->
        <div class="section">
            <div class="object-selector">
                <label><strong>üìù Nom du planning:</strong></label>
                <input type="text" id="nomObjet" placeholder="nom_planning" />
                <button id="pushBtn" class="btn-green">üöÄ Push View to NH28</button>
            </div>
        </div>

        <!-- Statistiques smarties -->
        <div id="statsSection" style="display: none;">
            <div class="section">
                <h3>üìä Statistiques Intelligentes</h3>
                <div class="stats-grid" id="statsGrid"></div>

                <div class="keywords-header">
                    <h4 class="keywords-title">üîç Analyse par Mots-cl√©s</h4>
                    <button id="manageKeywordsBtn" class="btn-purple btn-small">‚öôÔ∏è G√©rer</button>
                </div>

                <div id="keywordManager" class="keyword-manager" style="display: none;">
                    <h5 style="margin-bottom: 15px; color: #2c3e50;">üõ†Ô∏è Configuration des Mots-cl√©s</h5>
                    <div id="keywordList" class="keyword-list"></div>
                    <button id="addKeywordBtn" class="btn-add btn-small">‚ûï Ajouter un mot-cl√©</button>
                    <div class="keyword-controls">
                        <button id="resetKeywordsBtn" class="btn-orange btn-small">üîÑ R√©initialiser</button>
                        <button id="saveKeywordsBtn" class="btn-green btn-small">üíæ Sauvegarder</button>
                        <button id="closeKeywordsBtn" class="btn-purple btn-small">‚ùå Fermer</button>
                    </div>
                </div>

                <div class="keywords-stats-grid" id="keywordsStatsGrid"></div>

                <div id="repeatedTasks" class="repeated-tasks" style="display: none;">
                    <h4>üîÑ T√¢ches R√©p√©t√©es D√©tect√©es</h4>
                    <div id="repeatedTasksList"></div>
                </div>
            </div>
        </div>

        <!-- G√©rer Le Temps -->
        <div id="timeManagerSection" style="display: none;">
            <div class="section">
                <div class="time-manager-header">
                    <h3>‚è∞ G√©rer Le Temps</h3>
                    <button id="closeTimeManagerBtn" class="btn-purple btn-small">‚ùå Fermer</button>
                </div>

                <!-- √âl√©ment 1: Filtrage sur calendrier existant -->
                <div class="time-element">
                    <h4>üéØ Filtrer le calendrier actuel</h4>

                    <!-- Slider des semaines -->
                    <div class="slider-container">
                        <button class="slider-arrow" id="weekSliderLeft">‚Äπ</button>
                        <div class="slider-content" id="weekSliderContent">
                            <!-- Les semaines seront ajout√©es dynamiquement -->
                        </div>
                        <button class="slider-arrow" id="weekSliderRight">‚Ä∫</button>
                    </div>

                    <!-- Boutons des jours -->
                    <div class="days-row">
                        <button class="day-button" data-day="Lun">Lun</button>
                        <button class="day-button" data-day="Mar">Mar</button>
                        <button class="day-button" data-day="Mer">Mer</button>
                        <button class="day-button" data-day="Jeu">Jeu</button>
                        <button class="day-button" data-day="Ven">Ven</button>
                        <button class="day-button" data-day="Sam">Sam</button>
                        <button class="day-button" data-day="Dim">Dim</button>
                    </div>

                    <!-- Bouton filtrer -->
                    <button id="filterByTimeBtn" class="btn-orange">üéØ FILTRER SUR CE CRITERE</button>
                </div>

                <!-- √âl√©ment 2: G√©n√©ration de calendrier -->
                <div class="time-element">
                    <h4>üìÖ G√©n√©rateur de calendrier</h4>

                    <!-- Ann√©es -->
                    <div class="slider-container">
                        <button class="slider-arrow" id="yearSliderLeft">‚Äπ</button>
                        <div class="slider-content circular-slider" id="yearSliderContent">
                            <!-- Les ann√©es seront ajout√©es dynamiquement -->
                        </div>
                        <button class="slider-arrow" id="yearSliderRight">‚Ä∫</button>
                    </div>

                    <!-- Mois -->
                    <div class="slider-container">
                        <div style="flex: 1; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                            <div class="circular-item" data-month="1">Jan</div>
                            <div class="circular-item" data-month="2">F√©v</div>
                            <div class="circular-item" data-month="3">Mar</div>
                            <div class="circular-item" data-month="4">Avr</div>
                            <div class="circular-item" data-month="5">Mai</div>
                            <div class="circular-item" data-month="6">Jun</div>
                            <div class="circular-item" data-month="7">Jul</div>
                            <div class="circular-item" data-month="8">Ao√ª</div>
                            <div class="circular-item" data-month="9">Sep</div>
                            <div class="circular-item" data-month="10">Oct</div>
                            <div class="circular-item" data-month="11">Nov</div>
                            <div class="circular-item" data-month="12">D√©c</div>
                        </div>
                    </div>

                    <!-- Semaines -->
                    <div class="slider-container">
                        <button class="slider-arrow" id="weekNumSliderLeft">‚Äπ</button>
                        <div class="slider-content circular-slider" id="weekNumSliderContent">
                            <!-- Les num√©ros de semaines seront ajout√©es dynamiquement -->
                        </div>
                        <button class="slider-arrow" id="weekNumSliderRight">‚Ä∫</button>
                    </div>

                    <!-- Bouton g√©n√©rer -->
                    <button id="generateCalendarBtn" class="btn-green">üìÖ GENERER UN CALENDRIER</button>
                </div>
            </div>
        </div>

        <!-- Filtres et contr√¥les table -->
        <div class="section" id="tableSection" style="display: none;">
            <div class="table-section-header">
                <h3 id="table-section">üìã Table de Planning <a href="#calendar-section" style="font-size: 0.8em; margin-left: 15px; color: #007bff; text-decoration: none;">‚¨áÔ∏è Aller √† la Vue Calendaire</a></h3>
                <div class="section-controls">

                    <button id="refreshBtn" class="btn-orange">üîÑ Actualiser Vue Calendaire</button>
                </div>
            </div>

            <div class="controls">
                <label><strong>üéØ Filtrer par semaine:</strong></label>
                <select id="weekFilter">
                    <option value="">-- Toutes les semaines --</option>
                </select>
                <label><strong>üìÜ Filtrer par jour:</strong></label>
                <select id="dayFilter">
                    <option value="">-- Tous les jours --</option>
                    <option value="Lun">Lundi</option>
                    <option value="Mar">Mardi</option>
                    <option value="Mer">Mercredi</option>
                    <option value="Jeu">Jeudi</option>
                    <option value="Ven">Vendredi</option>
                    <option value="Sam">Samedi</option>
                    <option value="Dim">Dimanche</option>
                </select>

                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;
                <button id="clearFilterBtn" class="btn-orange">üóëÔ∏è Tout Afficher</button>

            </div>

            <!-- Nouveau filtre de texte -->
            <div class="text-filter">
                <label><strong>üîç Filtrer par texte:</strong></label>
                <textarea id="textFilter" placeholder="Saisir du texte pour filtrer les t√¢ches..."></textarea>
                <button id="clearTextFilterBtn" class="btn-orange">‚ùå Effacer</button>
            </div>

            <div class="table-container">
                <table id="planningTable">
                    <thead>
                        <tr>
                            <th>üìÖ Semaine</th>
                            <th>üìÜ Jour</th>
                            <th>üìù T√¢ches (Drag & Drop)</th>
                            <th>üîó URL</th>
                            <th>üé® Couleur</th>
                        </tr>
                    </thead>
                    <tbody id="planningTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vue calendaire -->
        <div class="calendar-view" id="calendarSection" style="display: none;">
            <h3 id="calendar-section">üìÖ Vue Calendaire Intelligente <a href="#table-section" style="font-size: 0.8em; margin-left: 15px; color: #007bff; text-decoration: none;">‚¨ÜÔ∏è Retour √† la Table</a></h3>
            <div id="calendarContainer"></div>
        </div>

        <!-- Messages de statut -->
        <div id="statusMessage" style="display: none;"></div>
    </div>

    <!-- Modal pour s√©lection de planning -->
    <div id="planningModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">üìÇ S√©lectionner un Planning</span>
                <span class="close">&times;</span>
            </div>
            <div class="planning-list" id="planningList">
                <div style="text-align: center; padding: 20px; color: #6c757d;">
                    üîç Recherche des plannings NH28_tree_PLANNING*...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentPlanningData = null;
        let currentPlanningName = '';
        let filteredWeek = '';
        let filteredDay = '';
        let filteredText = '';
        let autoSaveEnabled = false;
        let autoSaveTimer = null;
        let draggedElement = null;
        let draggedRow = null;

        // Variables pour G√©rer Le Temps
        let timeManagerVisible = false;
        let selectedWeek = '';
        let selectedDay = '';
        let selectedYears = [];
        let selectedMonths = [];
        let selectedWeekNumbers = [];
        let weekSliderIndex = 0;
        let yearSliderIndex = 0;
        let weekNumSliderIndex = 0;
        let availableWeeks = [];

        // Couleurs disponibles
        const availableColors = [
            { value: 'red', name: 'Rouge' },
            { value: 'blue', name: 'Bleu' },
            { value: 'green', name: 'Vert' },
            { value: 'yellow', name: 'Jaune' },
            { value: 'orange', name: 'Orange' },
            { value: 'purple', name: 'Violet' },
            { value: 'grey', name: 'Gris' },
            { value: 'brown', name: 'Marron' },
            { value: 'pink', name: 'Rose' },
            { value: 'cyan', name: 'Cyan' },
            { value: 'magenta', name: 'Magenta' },
            { value: 'lime', name: 'Lime' },
            { value: 'gold', name: 'Or' },
            { value: 'silver', name: 'Argent' }
        ];

        // Mapping des couleurs pour l'aper√ßu
        const colorMap = {
            'red': '#FF0000',
            'blue': '#0000FF',
            'green': '#008000',
            'yellow': '#FFFF00',
            'orange': '#FFA500',
            'purple': '#800080',
            'grey': '#808080',
            'brown': '#A52A2A',
            'pink': '#FFC0CB',
            'cyan': '#00FFFF',
            'magenta': '#FF00FF',
            'lime': '#00FF00',
            'gold': '#FFD700',
            'silver': '#C0C0C0'
        };

        // Mots-cl√©s √† analyser (configuration par d√©faut)
        let keywordAnalysis = [
            { keyword: 'pr√©parer', label: 'Pr√©parations' },
            { keyword: 'dispenser', label: 'Formations' },
            { keyword: 'code', label: 'Laboratoire' },
            { keyword: 'suivre', label: 'Suivis et Contacts' },
            { keyword: 'visio', label: 'Visioconf√©rences et RDV' },
            { keyword: 'transport', label: 'D√©placements' }
        ];

        // Fonction pour d√©terminer la classe CSS d'une t√¢che
        function getTaskStyleClass(taskContent) {
            if (!taskContent || taskContent === '- *') {
                return 'empty';
            }

            const content = taskContent.toLowerCase();

            if (content.includes('pr√©parer')) {
                return 'preparer';
            }
            if (content.includes('dispenser')) {
                return 'dispenser';
            }
            if (content.includes('code')) {
                return 'code';
            }
            if (content.includes('suivre')) {
                return 'suivre';
            }
            if (content.includes('visio')) {
                return 'visio';
            }
            if (content.includes('transport')) {
                return 'transport';
            }

            return '';
        }

        // R√©cup√©ration des √©l√©ments DOM
        const loadPlanningBtn = document.getElementById('loadPlanningBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const autoSaveBtn = document.getElementById('autoSaveBtn');
        const statsBtn = document.getElementById('statsBtn');
        const manageKeywordsBtn = document.getElementById('manageKeywordsBtn');
        const timeManagerBtn = document.getElementById('timeManagerBtn');
        const closeTimeManagerBtn = document.getElementById('closeTimeManagerBtn');
        const nomObjet = document.getElementById('nomObjet');
        const pushBtn = document.getElementById('pushBtn');
        const weekFilter = document.getElementById('weekFilter');
        const dayFilter = document.getElementById('dayFilter');
        const textFilter = document.getElementById('textFilter');
        const clearFilterBtn = document.getElementById('clearFilterBtn');
        const clearTextFilterBtn = document.getElementById('clearTextFilterBtn');
        const planningTable = document.getElementById('planningTable');
        const planningTableBody = document.getElementById('planningTableBody');
        const calendarContainer = document.getElementById('calendarContainer');
        const statusMessage = document.getElementById('statusMessage');
        const planningModal = document.getElementById('planningModal');
        const planningList = document.getElementById('planningList');
        const tableSection = document.getElementById('tableSection');
        const calendarSection = document.getElementById('calendarSection');
        const statsSection = document.getElementById('statsSection');
        const timeManagerSection = document.getElementById('timeManagerSection');
        const statsGrid = document.getElementById('statsGrid');
        const keywordsStatsGrid = document.getElementById('keywordsStatsGrid');
        const repeatedTasks = document.getElementById('repeatedTasks');
        const repeatedTasksList = document.getElementById('repeatedTasksList');
        const keywordManager = document.getElementById('keywordManager');
        const keywordList = document.getElementById('keywordList');
        const addKeywordBtn = document.getElementById('addKeywordBtn');
        const resetKeywordsBtn = document.getElementById('resetKeywordsBtn');
        const saveKeywordsBtn = document.getElementById('saveKeywordsBtn');
        const closeKeywordsBtn = document.getElementById('closeKeywordsBtn');

        // Nouveaux √©l√©ments pour G√©rer Le Temps
        const weekSliderContent = document.getElementById('weekSliderContent');
        const weekSliderLeft = document.getElementById('weekSliderLeft');
        const weekSliderRight = document.getElementById('weekSliderRight');
        const filterByTimeBtn = document.getElementById('filterByTimeBtn');
        const yearSliderContent = document.getElementById('yearSliderContent');
        const yearSliderLeft = document.getElementById('yearSliderLeft');
        const yearSliderRight = document.getElementById('yearSliderRight');
        const weekNumSliderContent = document.getElementById('weekNumSliderContent');
        const weekNumSliderLeft = document.getElementById('weekNumSliderLeft');
        const weekNumSliderRight = document.getElementById('weekNumSliderRight');
        const generateCalendarBtn = document.getElementById('generateCalendarBtn');

        // Event listeners
        loadPlanningBtn.addEventListener('click', showPlanningModal);
        refreshBtn.addEventListener('click', refreshCalendarView);
        autoSaveBtn.addEventListener('click', toggleAutoSave);
        statsBtn.addEventListener('click', toggleStats);
        manageKeywordsBtn.addEventListener('click', toggleKeywordManager);
        timeManagerBtn.addEventListener('click', toggleTimeManager);
        closeTimeManagerBtn.addEventListener('click', closeTimeManager);
        pushBtn.addEventListener('click', pushViewToNH28);
        weekFilter.addEventListener('change', applyFilters);
        dayFilter.addEventListener('change', applyFilters);
        textFilter.addEventListener('input', applyFilters);
        clearFilterBtn.addEventListener('click', clearAllFilters);
        clearTextFilterBtn.addEventListener('click', clearTextFilter);
        nomObjet.addEventListener('input', onPlanningNameChange);
        addKeywordBtn.addEventListener('click', addKeywordItem);
        resetKeywordsBtn.addEventListener('click', resetKeywords);
        saveKeywordsBtn.addEventListener('click', saveKeywords);
        closeKeywordsBtn.addEventListener('click', closeKeywordManager);

        // Event listeners pour G√©rer Le Temps
        weekSliderLeft.addEventListener('click', () => navigateWeekSlider(-1));
        weekSliderRight.addEventListener('click', () => navigateWeekSlider(1));
        filterByTimeBtn.addEventListener('click', applyTimeFilter);
        yearSliderLeft.addEventListener('click', () => navigateYearSlider(-1));
        yearSliderRight.addEventListener('click', () => navigateYearSlider(1));
        weekNumSliderLeft.addEventListener('click', () => navigateWeekNumSlider(-1));
        weekNumSliderRight.addEventListener('click', () => navigateWeekNumSlider(1));
        generateCalendarBtn.addEventListener('click', generateNewCalendar);

        // Modal events
        document.querySelector('.close').addEventListener('click', hidePlanningModal);
        window.addEventListener('click', (e) => {
            if (e.target === planningModal) hidePlanningModal();
        });

        // Fonctions utilitaires
        function showStatus(message, type = 'success') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        function ensureTaskFormat(task) {
            if (!task || task.trim() === '') {
                return '- *';
            }
            const trimmed = task.trim();
            if (!trimmed.startsWith('- ')) {
                return '- ' + trimmed;
            }
            return trimmed;
        }

        function showPlanningModal() {
            const plannings = findNH28Plannings();
            if (plannings.length === 0) {
                showStatus('‚ùå Aucun planning NH28_tree_PLANNING* trouv√© dans localStorage', 'error');
                return;
            }

            planningList.innerHTML = '';
            plannings.forEach(planning => {
                const item = document.createElement('div');
                item.className = 'planning-item';
                item.innerHTML = `
                                        <span class="planning-name">${planning.displayName}</span>
                                        <span class="planning-size">${planning.size}</span>
                                    `;
                item.addEventListener('click', () => loadPlanning(planning));
                planningList.appendChild(item);
            });

            planningModal.style.display = 'block';
        }

        function hidePlanningModal() {
            planningModal.style.display = 'none';
        }

        function findNH28Plannings() {
            const plannings = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('NH28_tree_PLANNING_')) {
                    const value = localStorage.getItem(key);
                    const sizeKB = Math.round(value.length / 1024);
                    plannings.push({
                        fullName: key,
                        displayName: key.replace('NH28_tree_PLANNING_', ''),
                        data: value,
                        size: `${sizeKB} KB`
                    });
                }
            }
            return plannings.sort((a, b) => a.displayName.localeCompare(b.displayName));
        }

        function loadPlanning(planning) {
            try {
                // Parser les donn√©es comme dans l'app pr√©c√©dente
                eval(planning.data);
                if (typeof data !== 'undefined') {
                    currentPlanningData = data;
                    currentPlanningName = planning.fullName;
                    nomObjet.value = planning.displayName;

                    generatePlanningTable();
                    generateCalendarView();
                    generateStats();
                    initializeTimeManager();

                    tableSection.style.display = 'block';
                    calendarSection.style.display = 'block';

                    hidePlanningModal();
                    showStatus(`‚úÖ Planning "${planning.displayName}" charg√© avec succ√®s !`);
                }
            } catch (error) {
                showStatus(`‚ùå Erreur lors du chargement: ${error.message}`, 'error');
            }
        }

        function generatePlanningTable() {
            if (!currentPlanningData) return;

            planningTableBody.innerHTML = '';
            weekFilter.innerHTML = '<option value="">-- Toutes les semaines --</option>';

            const weeks = extractWeeksFromData(currentPlanningData);

            // Populer le filtre des semaines
            weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = week.name;
                option.textContent = week.name;
                weekFilter.appendChild(option);
            });

            // G√©n√©rer les lignes de la table avec les filtres
            weeks.forEach(week => {
                // Filtre par semaine
                if (filteredWeek && week.name !== filteredWeek) return;

                week.days.forEach(day => {
                    // Filtre par jour
                    if (filteredDay && day.name !== filteredDay) return;

                    day.tasks.forEach((task, taskIndex) => {
                        const formattedTask = ensureTaskFormat(task.name);

                        // Filtre par texte
                        if (filteredText && !formattedTask.toLowerCase().includes(filteredText.toLowerCase())) {
                            return;
                        }

                        const row = document.createElement('tr');
                        row.innerHTML = `
                                                <td>${week.name}</td>
                                                <td>${day.name}</td>
                                                <td class="task-cell">
                                                    <textarea data-week="${week.name}" data-day="${day.name}" data-task="${taskIndex}"
                                                             class="${formattedTask === '- *' ? 'empty' : ''}"
                                                             draggable="true">${formattedTask}</textarea>
                                                </td>
                                                <td class="url-cell">
                                                    <textarea data-week="${week.name}" data-day="${day.name}" data-task="${taskIndex}"
                                                             placeholder="https://...">${task.url || ''}</textarea>
                                                    ${task.url ? `<a href="${task.url}" target="_blank" class="url-link">üîó Ouvrir</a>` : ''}
                                                </td>
                                                <td class="color-cell">
                                                    <div class="color-selector-container">
                                                        <select class="color-selector" data-week="${week.name}" data-day="${day.name}" data-task="${taskIndex}">
                                                            <option value="">-- Couleur --</option>
                                                            ${availableColors.map(color =>
                            `<option value="${color.value}" ${task.color === color.value ? 'selected' : ''}>${color.name}</option>`
                        ).join('')}
                                                        </select>
                                                        <div class="color-preview" style="background-color: ${colorMap[task.color] || '#f0f0f0'}"></div>
                                                    </div>
                                                </td>
                                            `;
                        planningTableBody.appendChild(row);
                    });
                });
            });

            // Ajouter les event listeners pour drag & drop et √©dition
            addTableEventListeners();
        }

        function extractWeeksFromData(data) {
            const weeks = [];

            function findWeeks(node, level = 0) {
                if (node.children) {
                    node.children.forEach(child => {
                        if (child.name === 'EXPLORER') {
                            findWeeks(child, level);
                        } else if (child.name.startsWith('Week_') || (level >= 1 && child.children)) {
                            // C'est une semaine
                            const week = {
                                name: child.name,
                                days: []
                            };

                            if (child.children) {
                                child.children.forEach(dayNode => {
                                    if (dayNode.name !== 'EXPLORER') {
                                        const day = {
                                            name: dayNode.name,
                                            tasks: []
                                        };

                                        if (dayNode.children) {
                                            dayNode.children.forEach(taskNode => {
                                                day.tasks.push({
                                                    name: ensureTaskFormat(taskNode.name),
                                                    url: taskNode.url || '',
                                                    color: taskNode.color || ''
                                                });
                                            });
                                        }

                                        if (day.tasks.length === 0) {
                                            day.tasks.push({
                                                name: '- *',
                                                url: '',
                                                color: ''
                                            });
                                        }

                                        week.days.push(day);
                                    }
                                });
                            }

                            weeks.push(week);
                        } else {
                            findWeeks(child, level + 1);
                        }
                    });
                }
            }

            findWeeks(data);
            return weeks;
        }

        function addTableEventListeners() {
            const textareas = planningTableBody.querySelectorAll('textarea');
            const colorSelectors = planningTableBody.querySelectorAll('.color-selector');

            // √âv√©nements pour les textareas
            textareas.forEach(textarea => {
                // √âv√©nements drag & drop
                textarea.addEventListener('dragstart', handleDragStart);
                textarea.addEventListener('dragover', handleDragOver);
                textarea.addEventListener('drop', handleDrop);
                textarea.addEventListener('dragend', handleDragEnd);

                // √âv√©nements d'√©dition
                textarea.addEventListener('input', handleTaskEdit);
                textarea.addEventListener('focus', handleTaskFocus);
                textarea.addEventListener('blur', handleTaskBlur);
            });

            // √âv√©nements pour les s√©lecteurs de couleur
            colorSelectors.forEach(selector => {
                selector.addEventListener('change', handleColorChange);
            });

            // Mise √† jour des liens URL
            updateUrlLinks();
        }

        function handleDragStart(e) {
            draggedElement = e.target;
            draggedRow = e.target.closest('tr');
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const targetRow = e.target.closest('tr');
            if (targetRow && targetRow !== draggedRow) {
                targetRow.querySelectorAll('.task-cell, .url-cell, .color-cell').forEach(cell => {
                    cell.classList.add('drop-zone');
                });
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetTextarea = e.target;
            const targetRow = targetTextarea.closest('tr');

            if (draggedElement && targetRow && draggedRow !== targetRow && targetTextarea.tagName === 'TEXTAREA') {
                // R√©cup√©rer toutes les donn√©es de la ligne source
                const sourceTaskTextarea = draggedRow.querySelector('.task-cell textarea');
                const sourceUrlTextarea = draggedRow.querySelector('.url-cell textarea');
                const sourceColorSelect = draggedRow.querySelector('.color-selector');

                // R√©cup√©rer toutes les donn√©es de la ligne cible
                const targetTaskTextarea = targetRow.querySelector('.task-cell textarea');
                const targetUrlTextarea = targetRow.querySelector('.url-cell textarea');
                const targetColorSelect = targetRow.querySelector('.color-selector');

                // √âchanger toutes les valeurs
                const tempTask = sourceTaskTextarea.value;
                const tempUrl = sourceUrlTextarea.value;
                const tempColor = sourceColorSelect.value;

                sourceTaskTextarea.value = '- *';
                sourceUrlTextarea.value = '';
                sourceColorSelect.value = '';
                sourceTaskTextarea.classList.add('empty');

                targetTaskTextarea.value = tempTask;
                targetUrlTextarea.value = tempUrl;
                targetColorSelect.value = tempColor;
                targetTaskTextarea.classList.remove('empty');

                // Mettre √† jour les donn√©es
                updateTaskInData(sourceTaskTextarea, '- *', '', '');
                updateTaskInData(targetTaskTextarea, tempTask, tempUrl, tempColor);

                // Mettre √† jour les aper√ßus de couleur et liens
                updateColorPreview(sourceColorSelect);
                updateColorPreview(targetColorSelect);
                updateUrlLinks();

                if (autoSaveEnabled) {
                    scheduleAutoSave();
                }

                showStatus('üìã T√¢che d√©plac√©e avec toutes ses propri√©t√©s !');
            }

            // Nettoyer les drop-zones
            document.querySelectorAll('.drop-zone').forEach(el => {
                el.classList.remove('drop-zone');
            });
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drop-zone').forEach(el => {
                el.classList.remove('drop-zone');
            });
        }

        function handleTaskEdit(e) {
            const textarea = e.target;
            let value = textarea.value;

            if (textarea.classList.contains('task-cell') || textarea.closest('.task-cell')) {
                // S'assurer que la t√¢che commence par "- "
                if (value.trim() !== '' && !value.startsWith('- ')) {
                    value = '- ' + value.trim();
                    textarea.value = value;
                }
                textarea.classList.toggle('empty', value === '- *');
            }

            updateTaskInData(textarea, value);

            if (autoSaveEnabled) {
                scheduleAutoSave();
            }
        }

        function handleTaskFocus(e) {
            if (e.target.value === '- *') {
                e.target.select();
            }
        }

        function handleTaskBlur(e) {
            if (e.target.classList.contains('task-cell') || e.target.closest('.task-cell')) {
                let value = e.target.value.trim();
                if (value === '' || value === '-') {
                    e.target.value = '- *';
                    e.target.classList.add('empty');
                    updateTaskInData(e.target, '- *');
                } else {
                    const formattedValue = ensureTaskFormat(value);
                    e.target.value = formattedValue;
                    updateTaskInData(e.target, formattedValue);
                }
            } else if (e.target.classList.contains('url-cell') || e.target.closest('.url-cell')) {
                updateTaskInData(e.target, e.target.value);
                updateUrlLinks();
            }
        }

        function handleColorChange(e) {
            const select = e.target;
            updateColorPreview(select);
            updateTaskInData(select, select.value);

            if (autoSaveEnabled) {
                scheduleAutoSave();
            }
        }

        function updateColorPreview(select) {
            const preview = select.parentNode.querySelector('.color-preview');
            const color = colorMap[select.value] || '#f0f0f0';
            preview.style.backgroundColor = color;
        }

        function updateUrlLinks() {
            const urlCells = planningTableBody.querySelectorAll('.url-cell');
            urlCells.forEach(cell => {
                const textarea = cell.querySelector('textarea');
                const existingLink = cell.querySelector('.url-link');

                if (existingLink) {
                    existingLink.remove();
                }

                if (textarea.value.trim()) {
                    const link = document.createElement('a');
                    link.href = textarea.value;
                    link.target = '_blank';
                    link.className = 'url-link';
                    link.textContent = 'üîó Ouvrir';
                    cell.appendChild(link);
                }
            });
        }

        function updateTaskInData(element, newValue, urlValue = null, colorValue = null) {
            const week = element.dataset.week;
            const day = element.dataset.day;
            const taskIndex = parseInt(element.dataset.task);

            // D√©terminer le type de champ
            let isTaskField = false;
            let isUrlField = false;
            let isColorField = false;

            if (element.tagName === 'TEXTAREA') {
                if (element.classList.contains('task-cell') || element.closest('.task-cell')) {
                    isTaskField = true;
                } else if (element.classList.contains('url-cell') || element.closest('.url-cell')) {
                    isUrlField = true;
                }
            } else if (element.tagName === 'SELECT') {
                isColorField = true;
            }

            // Mettre √† jour la structure de donn√©es
            function updateNode(node) {
                if (node.children) {
                    node.children.forEach(child => {
                        if (child.name === week) {
                            child.children?.forEach(dayNode => {
                                if (dayNode.name === day) {
                                    if (dayNode.children && dayNode.children[taskIndex]) {
                                        if (isTaskField || (urlValue !== null && colorValue !== null)) {
                                            if (isTaskField) {
                                                dayNode.children[taskIndex].name = newValue;
                                            } else {
                                                dayNode.children[taskIndex].name = newValue;
                                                dayNode.children[taskIndex].url = urlValue;
                                                dayNode.children[taskIndex].color = colorValue;
                                            }
                                        } else if (isUrlField) {
                                            dayNode.children[taskIndex].url = newValue;
                                        } else if (isColorField) {
                                            dayNode.children[taskIndex].color = newValue;
                                        }
                                    }
                                }
                            });
                        } else {
                            updateNode(child);
                        }
                    });
                }
            }

            updateNode(currentPlanningData);
        }

        function applyFilters() {
            filteredWeek = weekFilter.value;
            filteredDay = dayFilter.value;
            filteredText = textFilter.value.trim();
            generatePlanningTable();
            generateCalendarView();

            let filterInfo = '';
            if (filteredWeek) filterInfo += `üìÖ ${filteredWeek}`;
            if (filteredDay) filterInfo += (filterInfo ? ' - ' : '') + `üìÜ ${filteredDay}`;
            if (filteredText) filterInfo += (filterInfo ? ' - ' : '') + `üîç "${filteredText}"`;

            if (filterInfo) {
                showStatus(`üéØ Filtre appliqu√©: ${filterInfo}`);
            }
        }

        function clearAllFilters() {
            filteredWeek = '';
            filteredDay = '';
            filteredText = '';
            weekFilter.value = '';
            dayFilter.value = '';
            textFilter.value = '';
            generatePlanningTable();
            generateCalendarView();
            showStatus('üóëÔ∏è Tous les filtres supprim√©s');
        }

        function clearTextFilter() {
            filteredText = '';
            textFilter.value = '';
            generatePlanningTable();
            generateCalendarView();
            showStatus('‚ùå Filtre de texte effac√©');
        }

        function generateCalendarView() {
            if (!currentPlanningData) {
                return;
            }

            calendarContainer.innerHTML = '';
            const weeks = extractWeeksFromData(currentPlanningData);

            weeks.forEach(week => {
                if (filteredWeek && week.name !== filteredWeek) {
                    return;
                }

                const weekDiv = document.createElement('div');
                weekDiv.className = 'calendar-week';

                weekDiv.innerHTML = `
                                        <div class="calendar-week-header">
                                            üìÖ ${week.name}
                                        </div>
                                        <div class="calendar-days" id="days-${week.name}">
                                        </div>
                                    `;

                calendarContainer.appendChild(weekDiv);

                const daysContainer = document.getElementById(`days-${week.name}`);

                // Organiser les jours de Lun √† Dim
                const dayOrder = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                dayOrder.forEach(dayName => {
                    // Appliquer le filtre par jour
                    if (filteredDay && dayName !== filteredDay) return;

                    const day = week.days.find(d => d.name === dayName) || { name: dayName, tasks: [] };

                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';

                    let tasksHtml = '';
                    day.tasks.forEach(task => {
                        // Appliquer le filtre de texte
                        if (filteredText && !task.name.toLowerCase().includes(filteredText.toLowerCase())) {
                            return;
                        }

                        const taskClass = getTaskStyleClass(task.name);

                        // Cr√©er le contenu de la t√¢che avec lien int√©gr√©
                        let taskHtml = task.name;
                        if (task.url && task.url.trim() !== '') {
                            taskHtml += `<a href="${task.url}" target="_blank" class="calendar-url-link">*</a>`;
                        }

                        tasksHtml += `<div class="calendar-task ${taskClass}">${taskHtml}</div>`;
                    });

                    dayDiv.innerHTML = `
                                            <div class="calendar-day-header">${dayName}</div>
                                            ${tasksHtml}
                                        `;

                    daysContainer.appendChild(dayDiv);
                });

                // Si le filtre par jour est actif, ajuster la grille
                if (filteredDay) {
                    daysContainer.style.gridTemplateColumns = '1fr';
                }
            });
        }

        function refreshCalendarView() {
            generateCalendarView();
            showStatus('üîÑ Vue calendaire actualis√©e !');
        }

        function generateStats() {
            if (!currentPlanningData) return;

            const weeks = extractWeeksFromData(currentPlanningData);
            let totalTasks = 0;
            let totalEmptyTasks = 0;
            let busyDays = 0;
            let taskFrequency = new Map();
            let keywordCounts = {};

            // Initialiser les compteurs de mots-cl√©s
            keywordAnalysis.forEach(item => {
                keywordCounts[item.keyword] = 0;
            });

            weeks.forEach(week => {
                week.days.forEach(day => {
                    let dayTasks = 0;
                    day.tasks.forEach(task => {
                        totalTasks++;
                        if (task.name === '- *') {
                            totalEmptyTasks++;
                        } else {
                            dayTasks++;
                            // Analyser les t√¢ches r√©p√©t√©es (en retirant le pr√©fixe "- ")
                            const normalized = task.name.replace(/^- /, '').toLowerCase().trim();
                            if (normalized && normalized !== '*') {
                                taskFrequency.set(normalized, (taskFrequency.get(normalized) || 0) + 1);

                                // Analyser les mots-cl√©s
                                keywordAnalysis.forEach(item => {
                                    if (normalized.includes(item.keyword.toLowerCase())) {
                                        keywordCounts[item.keyword]++;
                                    }
                                });
                            }
                        }
                    });
                    if (dayTasks > 0) busyDays++;
                });
            });

            const filledTasks = totalTasks - totalEmptyTasks;
            const completion = totalTasks > 0 ? Math.round((filledTasks / totalTasks) * 100) : 0;

            // Trouver les t√¢ches r√©p√©t√©es
            const repeatedTasksArray = [];
            taskFrequency.forEach((count, task) => {
                if (count > 1) {
                    repeatedTasksArray.push({ task, count });
                }
            });

            repeatedTasksArray.sort((a, b) => b.count - a.count);

            // Afficher les statistiques principales
            statsGrid.innerHTML = `
                                    <div class="stat-card">
                                        <div class="stat-number">${weeks.length}</div>
                                        <div class="stat-label">üìÖ Semaines</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${busyDays}</div>
                                        <div class="stat-label">üìÜ Jours occup√©s</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${filledTasks}</div>
                                        <div class="stat-label">üìù T√¢ches planifi√©es</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${completion}%</div>
                                        <div class="stat-label">‚úÖ Taux de remplissage</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${repeatedTasksArray.length}</div>
                                        <div class="stat-label">üîÑ T√¢ches r√©p√©t√©es</div>
                                    </div>
                                `;

            // Afficher les statistiques par mots-cl√©s
            keywordsStatsGrid.innerHTML = keywordAnalysis.map(item => `
                                    <div class="keyword-stat-card">
                                        <div class="keyword-stat-number">${keywordCounts[item.keyword]}</div>
                                        <div class="keyword-stat-label">${item.label}</div>
                                    </div>
                                `).join('');

            // Afficher les t√¢ches r√©p√©t√©es
            if (repeatedTasksArray.length > 0) {
                repeatedTasksList.innerHTML = '';
                repeatedTasksArray.slice(0, 10).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'repeated-task-item';
                    div.innerHTML = `<strong>${item.task}</strong> <span style="color: #d63031;">(${item.count}x)</span>`;
                    repeatedTasksList.appendChild(div);
                });
                repeatedTasks.style.display = 'block';
            } else {
                repeatedTasks.style.display = 'none';
            }
        }

        function toggleStats() {
            const isVisible = statsSection.style.display !== 'none';

            // Fermer timeManager si ouvert
            if (timeManagerVisible) {
                timeManagerSection.style.display = 'none';
                timeManagerVisible = false;
                timeManagerBtn.textContent = '‚è∞ G√©rer Le Temps';
            }

            statsSection.style.display = isVisible ? 'none' : 'block';
            statsBtn.textContent = isVisible ? 'üìä Statistiques' : 'üìä Masquer Statistiques';

            if (!isVisible) {
                generateStats();
            }
        }

        function toggleAutoSave() {
            autoSaveEnabled = !autoSaveEnabled;
            autoSaveBtn.textContent = `üíæ Auto-Save: ${autoSaveEnabled ? 'ON' : 'OFF'}`;
            autoSaveBtn.className = autoSaveEnabled ? 'btn-green' : 'btn-purple';

            if (autoSaveEnabled) {
                showStatus('‚úÖ Auto-sauvegarde activ√©e (5s de d√©lai)');
            } else {
                showStatus('‚è∏Ô∏è Auto-sauvegarde d√©sactiv√©e');
                if (autoSaveTimer) {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = null;
                }
            }
        }

        function scheduleAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            autoSaveTimer = setTimeout(() => {
                pushViewToNH28(true);
            }, 5000);
        }

        function onPlanningNameChange() {
            if (autoSaveEnabled) {
                scheduleAutoSave();
            }
        }

        function pushViewToNH28(isAutoSave = false) {
            if (!currentPlanningData || !nomObjet.value.trim()) {
                showStatus('‚ùå Impossible de sauvegarder: donn√©es ou nom manquants', 'error');
                return;
            }

            try {
                const newObjectName = 'NH28_tree_PLANNING_' + nomObjet.value.trim();
                const dataString = `data = ${JSON.stringify(currentPlanningData, null, 2)};`;

                localStorage.setItem(newObjectName, dataString);
                currentPlanningName = newObjectName;

                const message = isAutoSave ?
                    `üíæ Auto-sauvegarde: "${nomObjet.value}"` :
                    `‚úÖ Planning sauvegard√©: "${nomObjet.value}"`;
                showStatus(message);
                showPopupAction()

            } catch (error) {
                showStatus(`‚ùå Erreur de sauvegarde: ${error.message}`, 'error');
            }
        }

        // Fonctions de gestion des mots-cl√©s
        function loadKeywordsConfig() {
            const saved = localStorage.getItem('NH28_keywords_config');
            if (saved) {
                try {
                    keywordAnalysis = JSON.parse(saved);
                } catch (error) {
                    console.warn('Erreur lors du chargement des mots-cl√©s:', error);
                }
            }
        }

        function showPopupAction() {
            const popup = document.createElement('div');
            popup.id = 'copilotPopup';
            popup.innerHTML = `
                        <div id="popupContent">
                            <span id="closePopup" onclick="closePopup()">√ó</span>
                            <a href="https://nh28.azurewebsites.net/_Mdl0_home/Z_2_Tree_Dynamic.html?nh28_id=12345&nh28_script=PLANNING_${nomObjet.value}" target="_blank" title="CLICK TO OPEN TREE VIEW">NH28 Tree
                            <img src="/_Mdl0_home/_4_img0/_002_NH_2_64_42.png" alt="Image">
                            </a>
                            <p>PUSH SUCCESSFULLY COMPLETED</p>
                        </div>
                    `;

            // Ajouter des styles pour centrer le popup
            popup.style.position = 'fixed';
            popup.style.top = '50%';
            popup.style.left = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.zIndex = '1000';

            document.body.appendChild(popup);

        }

        function closePopup() {
            const popup = document.getElementById('copilotPopup');
            if (popup) {
                popup.remove();
            }
        }

        function saveKeywordsConfig() {
            localStorage.setItem('NH28_keywords_config', JSON.stringify(keywordAnalysis));
        }

        function toggleKeywordManager() {
            const isVisible = keywordManager.style.display !== 'none';
            keywordManager.style.display = isVisible ? 'none' : 'block';
            manageKeywordsBtn.textContent = isVisible ? '‚öôÔ∏è G√©rer' : '‚ùå Fermer';

            if (!isVisible) {
                renderKeywordList();
            }
        }

        function closeKeywordManager() {
            keywordManager.style.display = 'none';
            manageKeywordsBtn.textContent = '‚öôÔ∏è G√©rer';
        }

        function renderKeywordList() {
            keywordList.innerHTML = '';

            keywordAnalysis.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'keyword-item';
                itemDiv.innerHTML = `
                                        <input type="text" class="keyword-input keyword-field"
                                               value="${item.keyword}"
                                               placeholder="Mot-cl√©"
                                               data-index="${index}"
                                               data-field="keyword">
                                        <input type="text" class="keyword-input label-field"
                                               value="${item.label}"
                                               placeholder="Description"
                                               data-index="${index}"
                                               data-field="label">
                                        <button class="btn-remove btn-small" onclick="removeKeywordItem(${index})">üóëÔ∏è</button>
                                    `;
                keywordList.appendChild(itemDiv);
            });

            // Ajouter les event listeners pour les inputs
            keywordList.querySelectorAll('.keyword-input').forEach(input => {
                input.addEventListener('input', updateKeywordItem);
            });
        }

        function updateKeywordItem(e) {
            const index = parseInt(e.target.dataset.index);
            const field = e.target.dataset.field;
            const value = e.target.value.trim();

            if (keywordAnalysis[index]) {
                keywordAnalysis[index][field] = value;
            }
        }

        function addKeywordItem() {
            keywordAnalysis.push({
                keyword: '',
                label: ''
            });
            renderKeywordList();

            // Focus sur le premier champ du nouvel item
            const newInputs = keywordList.querySelectorAll('.keyword-item:last-child .keyword-input');
            if (newInputs.length > 0) {
                newInputs[0].focus();
            }
        }

        function removeKeywordItem(index) {
            if (confirm('Supprimer ce mot-cl√© ?')) {
                keywordAnalysis.splice(index, 1);
                renderKeywordList();
                showStatus('üóëÔ∏è Mot-cl√© supprim√©');
            }
        }

        // Rendre la fonction accessible globalement pour onclick
        window.removeKeywordItem = removeKeywordItem;

        function resetKeywords() {
            if (confirm('R√©initialiser tous les mots-cl√©s aux valeurs par d√©faut ?')) {
                keywordAnalysis = [
                    { keyword: 'pr√©parer', label: 'Pr√©parations' },
                    { keyword: 'dispenser', label: 'Formations' },
                    { keyword: 'code', label: 'Laboratoire' },
                    { keyword: 'suivre', label: 'Suivis et Contacts' },
                    { keyword: 'visio', label: 'Visioconf√©rences' },
                    { keyword: 'transport', label: 'D√©placements' }
                ];
                renderKeywordList();
                generateCalendarView(); // Recalculer les couleurs
                showStatus('üîÑ Mots-cl√©s r√©initialis√©s');
            }
        }

        function saveKeywords() {
            // Filtrer les mots-cl√©s vides
            keywordAnalysis = keywordAnalysis.filter(item =>
                item.keyword.trim() !== '' && item.label.trim() !== ''
            );

            saveKeywordsConfig();
            generateStats(); // Recalculer les statistiques
            generateCalendarView(); // Recalculer les couleurs de la vue calendaire
            showStatus('üíæ Configuration des mots-cl√©s sauvegard√©e !');
        }

        // ============== FONCTIONS G√âRER LE TEMPS ==============

        function toggleTimeManager() {
            timeManagerVisible = !timeManagerVisible;

            // Fermer les statistiques si ouvertes
            if (statsSection.style.display !== 'none') {
                statsSection.style.display = 'none';
                statsBtn.textContent = 'üìä Statistiques';
            }

            timeManagerSection.style.display = timeManagerVisible ? 'block' : 'none';
            timeManagerBtn.textContent = timeManagerVisible ? '‚ùå Fermer Temps' : '‚è∞ G√©rer Le Temps';

            if (timeManagerVisible) {
                initializeTimeManager();
            }
        }

        function closeTimeManager() {
            timeManagerSection.style.display = 'none';
            timeManagerVisible = false;
            timeManagerBtn.textContent = '‚è∞ G√©rer Le Temps';
        }

        function initializeTimeManager() {
            // Initialiser les semaines disponibles seulement si on a des donn√©es
            if (currentPlanningData) {
                const weeks = extractWeeksFromData(currentPlanningData);
                availableWeeks = weeks.map(week => week.name);
            } else {
                availableWeeks = [];
            }

            // R√©initialiser les s√©lections
            selectedWeek = '';
            selectedDay = '';
            selectedYears = [];
            selectedMonths = [];
            selectedWeekNumbers = [];
            weekSliderIndex = 0;
            yearSliderIndex = 0;
            weekNumSliderIndex = 0;

            updateWeekSlider();
            updateYearSlider();
            updateWeekNumSlider();
            updateDayButtons();
            updateMonthDisplay();
        }


        function updateWeekSlider() {
            if (availableWeeks.length === 0) return;

            weekSliderContent.innerHTML = '';

            // Afficher 3 semaines √† la fois
            const itemsToShow = Math.min(8, availableWeeks.length);
            for (let i = 0; i < itemsToShow; i++) {
                const index = (weekSliderIndex + i) % availableWeeks.length;
                const weekName = availableWeeks[index];

                const item = document.createElement('div');
                item.className = `week-slider-item ${selectedWeek === weekName ? 'selected' : ''}`;
                item.textContent = weekName;
                item.addEventListener('click', () => selectWeek(weekName));
                weekSliderContent.appendChild(item);
            }
        }

        function navigateWeekSlider(direction) {
            weekSliderIndex = (weekSliderIndex + direction + availableWeeks.length) % availableWeeks.length;
            updateWeekSlider();
        }

        function selectWeek(weekName) {
            selectedWeek = selectedWeek === weekName ? '' : weekName;
            updateWeekSlider();
        }

        function updateDayButtons() {
            const dayButtons = document.querySelectorAll('.day-button');
            dayButtons.forEach(button => {
                button.classList.toggle('selected', selectedDay === button.dataset.day);
                button.addEventListener('click', () => selectDay(button.dataset.day));
            });
        }

        function selectDay(day) {
            selectedDay = selectedDay === day ? '' : day;
            updateDayButtons();
        }

        function applyTimeFilter() {
            if (selectedWeek) {
                weekFilter.value = selectedWeek;
                filteredWeek = selectedWeek;
            }

            if (selectedDay) {
                dayFilter.value = selectedDay;
                filteredDay = selectedDay;
            }

            generatePlanningTable();
            generateCalendarView();

            // Fermer le gestionnaire de temps
            closeTimeManager();

            let filterInfo = '';
            if (selectedWeek) filterInfo += `üìÖ ${selectedWeek}`;
            if (selectedDay) filterInfo += (filterInfo ? ' - ' : '') + `üìÜ ${selectedDay}`;

            showStatus(`üéØ Filtre temporel appliqu√©: ${filterInfo}`);
        }

        function updateYearSlider() {
            yearSliderContent.innerHTML = '';

            // G√©n√©rer les ann√©es de 2025 √† 2035
            const startYear = 2025;
            const endYear = 2035;
            const years = [];
            for (let year = startYear; year <= endYear; year++) {
                years.push(year);
            }

            // Afficher 10 ann√©es √† la fois
            const itemsToShow = Math.min(10, years.length);
            for (let i = 0; i < itemsToShow; i++) {
                const index = (yearSliderIndex + i) % years.length;
                const year = years[index];

                const item = document.createElement('div');
                item.className = `circular-item ${selectedYears.includes(year) ? 'selected' : ''}`;
                item.textContent = year;
                item.addEventListener('click', () => selectYear(year));
                yearSliderContent.appendChild(item);
            }
        }

        function navigateYearSlider(direction) {
            const totalYears = 11; // 2025 √† 2035
            yearSliderIndex = (yearSliderIndex + direction + totalYears) % totalYears;
            updateYearSlider();
        }

        function selectYear(year) {
            const index = selectedYears.indexOf(year);
            if (index === -1) {
                selectedYears.push(year);
            } else {
                selectedYears.splice(index, 1);
            }
            updateYearSlider();
        }

        function updateWeekNumSlider() {
            weekNumSliderContent.innerHTML = '';

            // Afficher 10 semaines √† la fois
            const itemsToShow = 10;
            for (let i = 0; i < itemsToShow; i++) {
                const weekNum = ((weekNumSliderIndex + i) % 53) + 1;

                const item = document.createElement('div');
                item.className = `circular-item ${selectedWeekNumbers.includes(weekNum) ? 'selected' : ''}`;
                item.textContent = weekNum;
                item.addEventListener('click', () => selectWeekNumber(weekNum));
                weekNumSliderContent.appendChild(item);
            }
        }

        function navigateWeekNumSlider(direction) {
            weekNumSliderIndex = (weekNumSliderIndex + direction + 53) % 53;
            updateWeekNumSlider();
        }

        function selectWeekNumber(weekNum) {
            const index = selectedWeekNumbers.indexOf(weekNum);
            if (index === -1) {
                selectedWeekNumbers.push(weekNum);
            } else {
                selectedWeekNumbers.splice(index, 1);
            }
            updateWeekNumSlider();
        }

        function selectMonth(month) {
            const index = selectedMonths.indexOf(month);
            if (index === -1) {
                selectedMonths.push(month);
            } else {
                selectedMonths.splice(index, 1);
            }
            updateMonthDisplay();
        }

        function updateMonthDisplay() {
            const monthItems = document.querySelectorAll('[data-month]');
            monthItems.forEach(item => {
                const month = parseInt(item.dataset.month);
                item.className = `circular-item ${selectedMonths.includes(month) ? 'selected' : ''}`;
            });
        }

        function generateNewCalendar() {
            if (selectedYears.length === 0) {
                showStatus('‚ùå Veuillez s√©lectionner au moins une ann√©e', 'error');
                return;
            }

            try {
                const calendarData = createCalendarStructure();

                // Sauvegarder dans localStorage
                const dataString = `data = ${JSON.stringify(calendarData, null, 2)};`;
                localStorage.setItem('NH28_tree_PLANNING_calendrierGenere', dataString);

                // Mettre √† jour l'interface
                currentPlanningData = calendarData;
                currentPlanningName = 'NH28_tree_PLANNING_calendrierGenere';
                nomObjet.value = 'calendrierGenere';

                // Fermer le gestionnaire de temps
                closeTimeManager();

                // Afficher le nouveau calendrier
                generatePlanningTable();
                generateCalendarView();
                generateStats();
                initializeTimeManager();

                tableSection.style.display = 'block';
                calendarSection.style.display = 'block';

                showStatus('‚úÖ Calendrier g√©n√©r√© avec succ√®s !');

            } catch (error) {
                showStatus(`‚ùå Erreur lors de la g√©n√©ration: ${error.message}`, 'error');
            }
        }

        function createCalendarStructure() {
            const calendar = {
                name: "calendrierGenere",
                children: []
            };

            const explorerNode = {
                name: "EXPLORER",
                children: []
            };

            // D√©terminer la plage de dates
            const minYear = Math.min(...selectedYears);
            const maxYear = Math.max(...selectedYears);

            let startDate, endDate;

            if (selectedMonths.length > 0 && selectedWeekNumbers.length > 0) {
                // Priorit√© aux semaines sur les mois
                startDate = getDateFromWeek(minYear, Math.min(...selectedWeekNumbers));
                endDate = getDateFromWeek(maxYear, Math.max(...selectedWeekNumbers));
                endDate.setDate(endDate.getDate() + 6); // Fin de la semaine
            } else if (selectedMonths.length > 0) {
                // Utiliser les mois
                const minMonth = Math.min(...selectedMonths);
                const maxMonth = Math.max(...selectedMonths);
                startDate = new Date(minYear, minMonth - 1, 1);
                endDate = new Date(maxYear, maxMonth, 0); // Dernier jour du mois
            } else if (selectedWeekNumbers.length > 0) {
                // Utiliser les semaines seulement
                startDate = getDateFromWeek(minYear, Math.min(...selectedWeekNumbers));
                endDate = getDateFromWeek(maxYear, Math.max(...selectedWeekNumbers));
                endDate.setDate(endDate.getDate() + 6);
            } else {
                // Ann√©e compl√®te
                startDate = new Date(minYear, 0, 1);
                endDate = new Date(maxYear, 11, 31);
            }

            // Ajuster au lundi pr√©c√©dent si n√©cessaire
            const startMonday = new Date(startDate);
            const dayOfWeek = startMonday.getDay();
            const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startMonday.setDate(startMonday.getDate() - daysToSubtract);

            // G√©n√©rer les semaines
            const currentDate = new Date(startMonday);
            let weekNumber = selectedWeekNumbers.length > 0 ? Math.min(...selectedWeekNumbers) : 1;

            while (currentDate <= endDate) {
                const weekName = formatWeekName(currentDate, weekNumber);
                const weekNode = {
                    name: weekName,
                    children: []
                };

                // Ajouter l'explorateur de semaine
                weekNode.children.push({
                    name: "EXPLORER",
                    children: []
                });

                // G√©n√©rer les 7 jours de la semaine
                const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                dayNames.forEach(dayName => {
                    const dayNode = {
                        name: dayName,
                        children: []
                    };

                    // Ajouter 10 t√¢ches par d√©faut
                    for (let i = 0; i < 10; i++) {
                        dayNode.children.push({
                            name: "- *",
                            url: "",
                            color: ""
                        });
                    }

                    weekNode.children.push(dayNode);
                });

                explorerNode.children.push(weekNode);

                // Passer √† la semaine suivante
                currentDate.setDate(currentDate.getDate() + 7);
                weekNumber++;
            }

            calendar.children.push(explorerNode);
            return calendar;
        }

        function getDateFromWeek(year, week) {
            const jan1 = new Date(year, 0, 1);
            const dayOfWeek = jan1.getDay();
            const daysToAdd = (week - 1) * 7 - (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
            const result = new Date(jan1);
            result.setDate(jan1.getDate() + daysToAdd);
            return result;
        }

        function formatWeekName(date, weekNumber) {
            const monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun',
                'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
            const month = monthNames[date.getMonth()];
            const day = date.getDate().toString().padStart(2, '0');
            const weekNum = weekNumber.toString().padStart(2, '0');

            return `Week_${weekNum}_${month}_${day}`;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            loadKeywordsConfig(); // Charger la configuration des mots-cl√©s

            // Initialiser les event listeners des mois d√®s le chargement
            const monthItems = document.querySelectorAll('[data-month]');
            monthItems.forEach(item => {
                item._monthClickHandler = () => selectMonth(parseInt(item.dataset.month));
                item.addEventListener('click', item._monthClickHandler);
            });

            showStatus('üöÄ NH28 Planning Manager Enhanced initialis√© - Pr√™t pour la gestion intelligente !');
        });

        // Rendre les fonctions accessibles globalement
        window.closePopup = closePopup;
        window.removeKeywordItem = removeKeywordItem;
    </script>
</body>
</html>
